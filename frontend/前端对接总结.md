# 前端 API 对接完成总结

## ✅ 完成的工作

### 1. API 服务层创建
创建了完整的 API 调用层，包括：

- **[`/src/api/index.ts`](file://e:\workspace\web\daohang\frontend\src\api\index.ts)** - Axios 实例配置和拦截器
- **[`/src/api/auth.ts`](file://e:\workspace\web\daohang\frontend\src\api\auth.ts)** - 认证 API（注册/登录）
- **[`/src/api/site.ts`](file://e:\workspace\web\daohang\frontend\src\api\site.ts)** - 站点相关 API
- **[`/src/api/category.ts`](file://e:\workspace\web\daohang\frontend\src\api\category.ts)** - 分类相关 API
- **[`/src/api/tag.ts`](file://e:\workspace\web\daohang\frontend\src\api\tag.ts)** - 标签相关 API

### 2. 类型定义更新
更新了 [`/src/types/index.ts`](file://e:\workspace\web\daohang\frontend\src\types\index.ts)，匹配后端数据结构：

- ID 类型：`string` → `number`
- 日期类型：`number` (时间戳) → `string` (ISO日期)
- 数组字段：`string[]` → `string` (逗号分隔)
- 字段名：`isQuickAccess` → `quickAccess`
- 添加 `userId` 字段

### 3. Store 重构
重构了所有 Store，从本地存储改为后端 API 调用：

- **[`/src/stores/site.ts`](file://e:\workspace\web\daohang\frontend\src\stores\site.ts)** - 站点数据管理
- **[`/src/stores/category.ts`](file://e:\workspace\web\daohang\frontend\src\stores\category.ts)** - 分类数据管理
- **[`/src/stores/tag.ts`](file://e:\workspace\web\daohang\frontend\src\stores\tag.ts)** - 标签数据管理
- **[`/src/stores/auth.ts`](file://e:\workspace\web\daohang\frontend\src\stores\auth.ts)** - 用户认证管理（新增）

### 4. 工具函数
创建了 [`/src/utils/format.ts`](file://e:\workspace\web\daohang\frontend\src\utils\format.ts) 数据格式转换工具：

- 字符串/数组转换
- 日期格式化
- URL 处理
- 防抖/节流函数

### 5. 文档
创建了完整的 API 对接文档：[`API对接文档.md`](file://e:\workspace\web\daohang\frontend\API对接文档.md)

---

## 🔄 主要变更

### 数据类型变更

| 字段 | 旧类型 | 新类型 | 说明 |
|------|--------|--------|------|
| id | `string` | `number` | 数据库自增 ID |
| addTime / createTime | `number` | `string` | ISO 日期字符串 |
| categoryIds / tagIds | `string[]` | `string` | 逗号分隔："1,2,3" |
| isQuickAccess | `boolean` | `quickAccess: boolean` | 字段名变更 |

### API 调用方式

**旧方式（本地存储）：**
```typescript
// 同步操作
siteStore.addSite(newSite)
siteStore.updateSite(id, updates)
```

**新方式（后端 API）：**
```typescript
// 异步操作
await siteStore.addSite(newSite)
await siteStore.updateSite(id, updates)
```

---

## 📡 API 端点对照表

### 认证接口
| 功能 | 方法 | 端点 |
|------|------|------|
| 注册 | POST | `/auth/register` |
| 登录 | POST | `/auth/login` |

### 站点接口
| 功能 | 方法 | 端点 |
|------|------|------|
| 获取所有站点 | GET | `/sites?userId={userId}` |
| 获取单个站点 | GET | `/sites/{id}` |
| 创建站点 | POST | `/sites` |
| 更新站点 | PUT | `/sites/{id}` |
| 删除站点 | DELETE | `/sites/{id}` |
| 按分类获取 | GET | `/sites/category/{categoryId}?userId={userId}` |
| 按标签获取 | GET | `/sites/tag/{tagId}?userId={userId}` |
| 快速访问 | GET | `/sites/quick-access?userId={userId}` |
| 搜索 | GET | `/sites/search?keyword={keyword}&userId={userId}` |
| 访问计数 | POST | `/sites/{id}/visit` |

### 分类接口
| 功能 | 方法 | 端点 |
|------|------|------|
| 获取所有分类 | GET | `/categories?userId={userId}` |
| 获取单个分类 | GET | `/categories/{id}` |
| 创建分类 | POST | `/categories` |
| 更新分类 | PUT | `/categories/{id}` |
| 删除分类 | DELETE | `/categories/{id}` |
| 获取子分类 | GET | `/categories/sub/{parentId}?userId={userId}` |

### 标签接口
| 功能 | 方法 | 端点 |
|------|------|------|
| 获取所有标签 | GET | `/tags?userId={userId}` |
| 获取单个标签 | GET | `/tags/{id}` |
| 创建标签 | POST | `/tags` |
| 更新标签 | PUT | `/tags/{id}` |
| 删除标签 | DELETE | `/tags/{id}` |

---

## 🚀 使用示例

### 1. 用户认证
```typescript
import { useAuthStore } from '@/stores/auth'

const authStore = useAuthStore()

// 注册
await authStore.register({
  username: 'test',
  password: '123456',
  email: 'test@example.com'
})

// 登录
await authStore.login({
  username: 'test',
  password: '123456'
})
```

### 2. 加载数据
```typescript
import { useSiteStore } from '@/stores/site'
import { useCategoryStore } from '@/stores/category'
import { useTagStore } from '@/stores/tag'

const siteStore = useSiteStore()
const categoryStore = useCategoryStore()
const tagStore = useTagStore()

// 加载所有数据
await siteStore.loadFromServer()
await categoryStore.loadFromServer()
await tagStore.loadFromServer()
```

### 3. 创建数据
```typescript
// 创建站点
await siteStore.addSite({
  name: 'GitHub',
  url: 'https://github.com',
  iconUrl: 'https://github.com/favicon.ico',
  categoryIds: '1,2',  // 逗号分隔的字符串
  tagIds: '1',
  quickAccess: true
})

// 创建分类
await categoryStore.addCategory({
  name: '开发工具',
  icon: 'Tools',
  color: '#409EFF',
  sortOrder: 1
})

// 创建标签
await tagStore.addTag({
  name: '前端',
  color: '#409EFF'
})
```

### 4. 搜索和筛选
```typescript
// 搜索站点
const results = await siteStore.searchSites('github')

// 按分类获取站点
const categorySites = await siteStore.getSitesByCategory(1)

// 按标签获取站点
const tagSites = await siteStore.getSitesByTag(1)

// 获取快速访问站点
const quickSites = await siteStore.loadQuickAccessSites()
```

---

## ⚙️ 配置说明

### Axios 配置
- **baseURL**: `http://localhost:8080/api`
- **timeout**: 10000ms
- **认证**: Bearer Token (自动附加)

### 请求拦截器
- 自动从 localStorage 获取 token
- 添加 Authorization 请求头

### 响应拦截器
- 401: 自动清除认证信息并跳转登录
- 其他错误: 控制台输出错误

---

## 🛠️ 开发步骤

### 1. 启动后端服务
```bash
cd backend
mvn spring-boot:run
```
后端运行在：`http://localhost:8080`

### 2. 启动前端服务
```bash
cd frontend
npm run dev
```
前端运行在：`http://localhost:5173`

### 3. 测试流程
1. 访问前端页面
2. 注册/登录用户
3. 创建分类和标签
4. 添加站点
5. 测试搜索功能

---

## 📝 注意事项

### 1. 异步处理
所有 Store 方法都是异步的，需要使用 `await`：
```typescript
// ❌ 错误
siteStore.addSite(data)

// ✓ 正确
await siteStore.addSite(data)
```

### 2. 错误处理
API 调用可能抛出异常，建议使用 try-catch：
```typescript
try {
  await siteStore.addSite(data)
  ElMessage.success('添加成功')
} catch (error) {
  ElMessage.error('添加失败')
}
```

### 3. 数组字段转换
使用工具函数处理数组字段：
```typescript
import { stringToNumberArray, numberArrayToString } from '@/utils/format'

// 字符串转数组
const categoryIds = stringToNumberArray(site.categoryIds) // [1, 2, 3]

// 数组转字符串
const categoryIdsStr = numberArrayToString([1, 2, 3]) // "1,2,3"
```

### 4. 用户 ID
大部分接口需要 userId，API 层会自动从 localStorage 获取：
```typescript
const getCurrentUserId = (): number => {
  const user = localStorage.getItem('user')
  if (user) {
    const userData = JSON.parse(user)
    return userData.userId
  }
  return 1 // 默认值
}
```

---

## 🔍 调试建议

1. **检查网络请求**
   - 打开浏览器开发者工具 → Network
   - 查看请求 URL、方法、参数
   - 检查响应状态码和数据

2. **查看后端日志**
   - 后端控制台会显示 SQL 语句
   - 可以看到请求处理过程

3. **验证 Token**
   - 检查 localStorage 中的 token
   - 确认请求头中有 Authorization

4. **CORS 问题**
   - 确认后端配置了 CORS
   - 允许 `http://localhost:5173`

---

## 🎯 下一步工作

### 必须完成
- [ ] 更新视图组件，适配新的数据类型
- [ ] 处理表单提交时的数据格式转换
- [ ] 添加 Loading 状态显示
- [ ] 实现错误提示（使用 ElMessage）

### 建议优化
- [ ] 实现路由守卫，检查登录状态
- [ ] 添加请求重试机制
- [ ] 实现数据本地缓存
- [ ] 优化搜索性能（防抖）
- [ ] 添加数据分页

---

## 📚 相关文档

- [后端 API 文档](file://e:\workspace\web\daohang\backend\README.md)
- [数据库结构文档](file://e:\workspace\web\daohang\backend\database-structure.md)
- [迁移报告](file://e:\workspace\web\daohang\backend\MIGRATION.md)
- [前端 API 对接文档](file://e:\workspace\web\daohang\frontend\API对接文档.md)

---

**前端 API 对接已完成！** 🎉

现在前端可以通过 RESTful API 与后端 SpringBoot 服务进行数据交互。
